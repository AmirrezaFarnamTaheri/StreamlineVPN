<!-- ===================================================================
     CONFIG_GENERATOR.HTML - ENHANCED CONFIGURATION GENERATOR
     =================================================================== -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamlineVPN Configuration Generator</title>
    <meta name="description" content="Generate custom VPN configurations with advanced options and real-time validation">

    <!-- Stylesheets -->
    <link href="assets/css/style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Scripts -->
    <script src="/api-base.js"></script>

    <style>
        body.config-generator {
            font-family: 'Inter', system-ui, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #ffffff;
        }

        .config-generator .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
        }

        .step {
            display: flex;
            align-items: center;
            margin: 0 20px;
            transition: all 0.3s ease;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: linear-gradient(135deg, #667eea, #f093fb);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        .step.completed .step-number {
            background: linear-gradient(135deg, #10b981, #34d399);
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .protocol-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .protocol-card {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .protocol-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .protocol-card:hover::before {
            left: 100%;
        }

        .protocol-card:hover {
            border-color: #667eea;
            transform: translateY(-4px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .protocol-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin: 30px 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .config-preview {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 24px;
            margin: 30px 0;
            border-left: 4px solid #667eea;
        }

        .config-preview pre {
            margin: 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #e2e8f0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .button-group {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 40px;
        }

        .config-generator .button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-width: 140px;
        }

        .config-generator .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .config-generator .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .config-generator .button.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .validation-message {
            margin-top: 8px;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 8px;
            display: none;
        }

        .validation-message.error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
            display: block;
        }

        .validation-message.success {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.3);
            display: block;
        }

        .advanced-toggle {
            text-align: center;
            margin: 30px 0;
        }

        .advanced-toggle button {
            background: none;
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.8);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .advanced-toggle button:hover {
            border-color: #667eea;
            color: white;
        }

        .advanced-options {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .advanced-options.show {
            display: block;
            animation: fadeInUp 0.5s ease-out;
        }

        @media (max-width: 768px) {
            .config-generator .container {
                margin: 10px;
                padding: 20px;
            }

            .protocol-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .step-indicator {
                flex-direction: column;
                align-items: center;
            }

            .step {
                margin: 10px 0;
            }

            .button-group {
                flex-direction: column;
            }

            .config-generator .button {
                width: 100%;
            }
        }
    </style>
</head>
<body class="config-generator">
    <div class="animated-bg"></div>

    <div class="container">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4">Configuration Generator</h1>
            <p class="text-lg opacity-90 mb-4">Create custom VPN configurations with advanced validation and optimization</p>
            <nav class="flex space-x-4 justify-center text-lg">
                <a href="index.html" class="text-blue-300 hover:underline">Home</a>
                <a href="interactive.html" class="text-blue-300 hover:underline">Control Panel</a>
                <a href="config_generator.html" class="text-blue-300 hover:underline font-bold">Generator</a>
                <a href="api/index.html" class="text-blue-300 hover:underline">API Docs</a>
                <a href="ws-test.html" class="text-blue-300 hover:underline">WebSocket Test</a>
                <a href="upload-test.html" class="text-blue-300 hover:underline">Upload Demo</a>
            </nav>
        </header>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">Select Protocol</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-label">Parameters</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-label">Output</div>
            </div>
        </div>

        <!-- Step 1: Protocol Selection -->
        <div class="step-content active" data-step="1">
            <h2 class="text-2xl font-semibold mb-6 text-center">Choose VPN Protocol</h2>

            <div class="protocol-grid">
                <div class="protocol-card" data-protocol="vless">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl mr-4">
                            VL
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold">VLESS</h3>
                            <p class="text-sm opacity-80">Lightweight, secure protocol</p>
                        </div>
                    </div>
                    <p class="text-sm opacity-70 mb-4">
                        Modern protocol with excellent performance and security. Supports XTLS for enhanced speed.
                    </p>
                    <div class="flex items-center justify-between">
                        <span class="quality-badge quality-excellent">Excellent</span>
                        <span class="text-xs opacity-60">Recommended</span>
                    </div>
                </div>

                <div class="protocol-card" data-protocol="vmess">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-green-600 rounded-lg flex items-center justify-center text-white font-bold text-xl mr-4">
                            VM
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold">VMess</h3>
                            <p class="text-sm opacity-80">Versatile and reliable</p>
                        </div>
                    </div>
                    <p class="text-sm opacity-70 mb-4">
                        Battle-tested protocol with strong encryption and wide client support.
                    </p>
                    <div class="flex items-center justify-between">
                        <span class="quality-badge quality-good">Good</span>
                        <span class="text-xs opacity-60">Stable</span>
                    </div>
                </div>

                <div class="protocol-card" data-protocol="shadowsocks">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-400 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold text-xl mr-4">
                            SS
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold">Shadowsocks</h3>
                            <p class="text-sm opacity-80">Simple and fast</p>
                        </div>
                    </div>
                    <p class="text-sm opacity-70 mb-4">
                        Lightweight SOCKS5 proxy with strong encryption. Great for bypassing censorship.
                    </p>
                    <div class="flex items-center justify-between">
                        <span class="quality-badge quality-good">Good</span>
                        <span class="text-xs opacity-60">Popular</span>
                    </div>
                </div>

                <div class="protocol-card" data-protocol="trojan">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-red-400 to-red-600 rounded-lg flex items-center justify-center text-white font-bold text-xl mr-4">
                            TJ
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold">Trojan</h3>
                            <p class="text-sm opacity-80">Stealth and security</p>
                        </div>
                    </div>
                    <p class="text-sm opacity-70 mb-4">
                        Mimics HTTPS traffic for enhanced stealth capabilities and censorship resistance.
                    </p>
                    <div class="flex items-center justify-between">
                        <span class="quality-badge quality-excellent">Excellent</span>
                        <span class="text-xs opacity-60">Stealth</span>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="button" id="next-step-1" disabled>
                    Next: Configure Parameters
                </button>
            </div>
        </div>

        <!-- Step 2: Parameters -->
        <div class="step-content" data-step="2">
            <h2 class="text-2xl font-semibold mb-6 text-center">Configuration Parameters</h2>

            <div class="form-grid">
                <div>
                    <div class="form-group">
                        <label class="form-label" for="server-host">Server Host</label>
                        <div class="validation-message" id="host-validation"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="server-port">Server Port</label>
                        <input type="number" id="server-port" class="form-input" placeholder="443" min="1" max="65535" required>
                        <div class="validation-message" id="port-validation"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="user-id">User ID / Password</label>
                        <input type="text" id="user-id" class="form-input" placeholder="Auto-generate UUID">
                        <button type="button" id="generate-uuid" class="button secondary" style="margin-top: 8px; padding: 8px 16px; font-size: 14px;">
                            Generate New UUID
                        </button>
                    </div>
                </div>

                <div>
                    <div class="form-group">
                        <label class="form-label" for="encryption">Encryption Method</label>
                        <select id="encryption" class="form-select">
                            <option value="auto">Auto (Recommended)</option>
                            <option value="aes-128-gcm">AES-128-GCM</option>
                            <option value="aes-256-gcm">AES-256-GCM</option>
                            <option value="chacha20-poly1305">ChaCha20-Poly1305</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="network-type">Network Type</label>
                        <select id="network-type" class="form-select">
                            <option value="tcp">TCP</option>
                            <option value="ws">WebSocket</option>
                            <option value="grpc">gRPC</option>
                            <option value="kcp">mKCP</option>
                            <option value="quic">QUIC</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="security">Security</label>
                        <select id="security" class="form-select">
                            <option value="none">None</option>
                            <option value="tls">TLS</option>
                            <option value="reality">Reality</option>
                            <option value="xtls">XTLS</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="advanced-toggle">
                <button type="button" id="toggle-advanced">
                    Show Advanced Options
                </button>
            </div>

            <div class="advanced-options" id="advanced-options">
                <h3 class="text-xl font-semibold mb-4">Advanced Configuration</h3>

                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <label class="form-label" for="path">Path (WebSocket/HTTP)</label>
                            <input type="text" id="path" class="form-input" placeholder="/path">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="host-header">Host Header</label>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="sni">SNI (Server Name Indication)</label>
                        </div>
                    </div>

                    <div>
                        <div class="form-group">
                            <label class="form-label" for="alpn">ALPN</label>
                            <input type="text" id="alpn" class="form-input" placeholder="h2,http/1.1">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="flow">Flow Control</label>
                            <select id="flow" class="form-select">
                                <option value="">None</option>
                                <option value="xtls-rprx-direct">XTLS-RPRX-Direct</option>
                                <option value="xtls-rprx-origin">XTLS-RPRX-Origin</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="fingerprint">Fingerprint</label>
                            <select id="fingerprint" class="form-select">
                                <option value="">None</option>
                                <option value="chrome">Chrome</option>
                                <option value="firefox">Firefox</option>
                                <option value="safari">Safari</option>
                                <option value="randomized">Randomized</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="button secondary" id="prev-step-2">
                    Previous: Select Protocol
                </button>
                <button class="button" id="next-step-2">
                    Next: Generate Configuration
                </button>
            </div>
        </div>

        <!-- Step 3: Output -->
        <div class="step-content" data-step="3">
            <h2 class="text-2xl font-semibold mb-6 text-center">Generated Configuration</h2>

            <div class="config-preview">
                <h3 class="text-lg font-semibold mb-4">Configuration Preview</h3>
                <pre id="config-output">Select protocol and configure parameters to generate configuration...</pre>
            </div>

            <div class="form-group">
                <label class="form-label" for="output-format">Output Format</label>
                <select id="output-format" class="form-select">
                    <option value="json">JSON</option>
                    <option value="url">Share URL</option>
                    <option value="clash">Clash YAML</option>
                    <option value="singbox">Sing-Box JSON</option>
                    <option value="qr">QR Code</option>
                </select>
            </div>

            <div class="button-group">
                <button class="button secondary" id="prev-step-3">
                    Previous: Configure Parameters
                </button>
                <button class="button" id="copy-config">
                    Copy Configuration
                </button>
                <button class="button" id="download-config">
                    Download File
                </button>
                <button class="button" id="test-config">
                    Test Configuration
                </button>
            </div>

            <div class="text-center mt-8">
                <button class="button secondary" id="start-over">
                    Start Over
                </button>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="text-center">
                <h3 class="text-xl font-semibold mb-4">QR Code</h3>
                <div id="qr-code-container" class="mb-6">
                    <!-- QR code will be generated here -->
                </div>
                <button class="button secondary" id="close-qr-modal">Close</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        // Configuration Generator Application
        class ConfigGenerator {
            constructor() {
                this.currentStep = 1;
                this.selectedProtocol = null;
                this.config = {};
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.generateUUID();
            }

            setupEventListeners() {
                // Protocol selection
                document.querySelectorAll('.protocol-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        this.selectProtocol(e.currentTarget.dataset.protocol);
                    });
                });

                // Step navigation
                document.getElementById('next-step-1').addEventListener('click', () => this.nextStep());
                document.getElementById('prev-step-2').addEventListener('click', () => this.prevStep());
                document.getElementById('next-step-2').addEventListener('click', () => this.nextStep());
                document.getElementById('prev-step-3').addEventListener('click', () => this.prevStep());

                // Form inputs with real-time validation
                document.getElementById('server-host').addEventListener('input', this.validateHost.bind(this));
                document.getElementById('server-port').addEventListener('input', this.validatePort.bind(this));
                document.getElementById('user-id').addEventListener('input', this.updateConfig.bind(this));

                // Advanced options toggle
                document.getElementById('toggle-advanced').addEventListener('click', this.toggleAdvancedOptions);

                // UUID generation
                document.getElementById('generate-uuid').addEventListener('click', this.generateUUID);

                // Output format change
                document.getElementById('output-format').addEventListener('change', this.updateConfigOutput.bind(this));

                // Action buttons
                document.getElementById('copy-config').addEventListener('click', this.copyConfig.bind(this));
                document.getElementById('download-config').addEventListener('click', this.downloadConfig.bind(this));
                document.getElementById('test-config').addEventListener('click', this.testConfig.bind(this));
                document.getElementById('start-over').addEventListener('click', this.startOver.bind(this));

                // Form change listeners
                ['encryption', 'network-type', 'security', 'path', 'host-header', 'sni', 'alpn', 'flow', 'fingerprint'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', this.updateConfig.bind(this));
                    }
                });
            }

            selectProtocol(protocol) {
                // Remove previous selection
                document.querySelectorAll('.protocol-card').forEach(card => {
                    card.classList.remove('selected');
                });

                // Add selection to clicked card
                document.querySelector(`[data-protocol="${protocol}"]`).classList.add('selected');

                this.selectedProtocol = protocol;
                document.getElementById('next-step-1').disabled = false;

                // Update form fields based on protocol
                this.updateProtocolSpecificFields(protocol);
            }

            updateProtocolSpecificFields(protocol) {
                // Show/hide relevant fields based on protocol
                const encryptionSelect = document.getElementById('encryption');
                const userIdInput = document.getElementById('user-id');
                const userIdLabel = userIdInput.previousElementSibling;

                if (protocol === 'shadowsocks') {
                    userIdLabel.textContent = 'Password';
                    userIdInput.placeholder = 'Enter password';
                    // Update encryption options for Shadowsocks
                    encryptionSelect.innerHTML = `
                        <option value="aes-128-gcm">AES-128-GCM</option>
                        <option value="aes-256-gcm">AES-256-GCM</option>
                        <option value="chacha20-ietf-poly1305">ChaCha20-IETF-Poly1305</option>
                        <option value="2022-blake3-aes-128-gcm">2022-Blake3-AES-128-GCM</option>
                        <option value="2022-blake3-aes-256-gcm">2022-Blake3-AES-256-GCM</option>
                    `;
                } else if (protocol === 'trojan') {
                    userIdLabel.textContent = 'Password';
                    userIdInput.placeholder = 'Enter password';
                } else {
                    userIdLabel.textContent = 'User ID';
                    userIdInput.placeholder = 'Auto-generate UUID';
                }
            }

            validateHost() {
                const hostInput = document.getElementById('server-host');
                const validation = document.getElementById('host-validation');
                const host = hostInput.value.trim();

                if (!host) {
                    this.showValidation(validation, 'Host is required', 'error');
                    return false;
                }

                // Simple validation for IP or domain
                const isValidIP = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(host);
                const isValidDomain = /^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9](?:\.[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9])*$/.test(host);

                if (!isValidIP && !isValidDomain) {
                    this.showValidation(validation, 'Invalid host format', 'error');
                    return false;
                }

                this.showValidation(validation, 'Valid host', 'success');
                return true;
            }

            validatePort() {
                const portInput = document.getElementById('server-port');
                const validation = document.getElementById('port-validation');
                const port = parseInt(portInput.value);

                if (!port || port < 1 || port > 65535) {
                    this.showValidation(validation, 'Port must be between 1 and 65535', 'error');
                    return false;
                }

                this.showValidation(validation, 'Valid port', 'success');
                return true;
            }

            showValidation(element, message, type) {
                element.textContent = message;
                element.className = `validation-message ${type}`;
            }

            toggleAdvancedOptions() {
                const options = document.getElementById('advanced-options');
                const button = document.getElementById('toggle-advanced');

                if (options.classList.contains('show')) {
                    options.classList.remove('show');
                    button.textContent = 'Show Advanced Options';
                } else {
                    options.classList.add('show');
                    button.textContent = 'Hide Advanced Options';
                }
            }

            generateUUID() {
                // Generate a UUID v4
                const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });

                document.getElementById('user-id').value = uuid;
                this.updateConfig();
            }

            updateConfig() {
                if (!this.selectedProtocol) return;

                // Gather form data
                this.config = {
                    protocol: this.selectedProtocol,
                    server: document.getElementById('server-host').value,
                    port: parseInt(document.getElementById('server-port').value) || 443,
                    uuid: document.getElementById('user-id').value,
                    encryption: document.getElementById('encryption').value,
                    network: document.getElementById('network-type').value,
                    security: document.getElementById('security').value,
                    path: document.getElementById('path').value,
                    host: document.getElementById('host-header').value,
                    sni: document.getElementById('sni').value,
                    alpn: document.getElementById('alpn').value,
                    flow: document.getElementById('flow').value,
                    fingerprint: document.getElementById('fingerprint').value
                };

                this.updateConfigOutput();
            }

            updateConfigOutput() {
                const format = document.getElementById('output-format').value;
                const output = document.getElementById('config-output');

                try {
                    let configText = '';

                    switch (format) {
                        case 'json':
                            configText = JSON.stringify(this.config, null, 2);
                            break;
                        case 'url':
                            configText = this.generateShareURL();
                            break;
                        case 'clash':
                            configText = this.generateClashConfig();
                            break;
                        case 'singbox':
                            configText = this.generateSingBoxConfig();
                            break;
                        case 'qr':
                            configText = 'QR Code will be generated when you select this option';
                            break;
                        default:
                            configText = JSON.stringify(this.config, null, 2);
                    }

                    output.textContent = configText;
                } catch (error) {
                    output.textContent = `Error generating configuration: ${error.message}`;
                }
            }

            generateShareURL() {
                const { protocol, server, port, uuid, encryption, network, security, path, host, sni } = this.config;

                switch (protocol) {
                    case 'vless':
                        return `vless://${uuid}@${server}:${port}?encryption=${encryption}&security=${security}&type=${network}&host=${host}&path=${path}&sni=${sni}#StreamlineVPN`;
                    case 'vmess':
                        const vmessConfig = {
                            v: "2",
                            ps: "StreamlineVPN",
                            add: server,
                            port: port,
                            id: uuid,
                            aid: "0",
                            net: network,
                            type: "none",
                            host: host,
                            path: path,
                            tls: security
                        };
                        return 'vmess://' + btoa(JSON.stringify(vmessConfig));
                    case 'shadowsocks':
                        const method = encryption;
                        const password = uuid; // For SS, we use uuid field as password
                        const userInfo = btoa(`${method}:${password}`);
                        return `ss://${userInfo}@${server}:${port}#StreamlineVPN`;
                    case 'trojan':
                        return `trojan://${uuid}@${server}:${port}?security=${security}&type=${network}&host=${host}&path=${path}&sni=${sni}#StreamlineVPN`;
                    default:
                        return 'Unsupported protocol for URL generation';
                }
            }

            generateClashConfig() {
                const { protocol, server, port, uuid, encryption, network, security, path, host, sni } = this.config;

                let clashConfig = {
                    name: "StreamlineVPN",
                    server: server,
                    port: port,
                    type: protocol
                };

                switch (protocol) {
                    case 'vless':
                        clashConfig = {
                            ...clashConfig,
                            uuid: uuid,
                            tls: security === 'tls',
                            network: network,
                            "ws-opts": network === 'ws' ? {
                                path: path,
                                headers: { Host: host }
                            } : undefined
                        };
                        break;
                    case 'vmess':
                        clashConfig = {
                            ...clashConfig,
                            uuid: uuid,
                            alterId: 0,
                            cipher: encryption,
                            tls: security === 'tls',
                            network: network,
                            "ws-opts": network === 'ws' ? {
                                path: path,
                                headers: { Host: host }
                            } : undefined
                        };
                        break;
                    case 'shadowsocks':
                        clashConfig = {
                            ...clashConfig,
                            type: 'ss',
                            cipher: encryption,
                            password: uuid
                        };
                        break;
                    case 'trojan':
                        clashConfig = {
                            ...clashConfig,
                            password: uuid,
                            sni: sni
                        };
                        break;
                }

                return `proxies:\n  - ${JSON.stringify(clashConfig, null, 4).replace(/^/gm, '    ')}`;
            }

            generateSingBoxConfig() {
                // This would generate Sing-Box configuration format
                // Simplified version for demo
                return JSON.stringify({
                    outbound: {
                        type: this.config.protocol,
                        tag: "StreamlineVPN",
                        server: this.config.server,
                        port: this.config.port,
                        uuid: this.config.uuid,
                        // Add more protocol-specific fields
                    }
                }, null, 2);
            }

            async copyConfig() {
                const output = document.getElementById('config-output').textContent;

                try {
                    await navigator.clipboard.writeText(output);
                    this.showToast('Configuration copied to clipboard!', 'success');
                } catch (error) {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = output;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showToast('Configuration copied to clipboard!', 'success');
                }
            }

            downloadConfig() {
                const output = document.getElementById('config-output').textContent;
                const format = document.getElementById('output-format').value;

                let filename = 'streamline-config';
                let mimeType = 'text/plain';

                switch (format) {
                    case 'json':
                        filename += '.json';
                        mimeType = 'application/json';
                        break;
                    case 'clash':
                        filename += '.yaml';
                        mimeType = 'application/x-yaml';
                        break;
                    case 'url':
                        filename += '.txt';
                        break;
                    default:
                        filename += '.txt';
                }

                const blob = new Blob([output], { type: mimeType });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.showToast('Configuration downloaded!', 'success');
            }

            async testConfig() {
                try {
                    this.showToast('Testing configuration...', 'info');

                    // Test configuration via API
                    const response = await API.post('/api/v1/validate-config', {
                        config: this.config
                    });

                    if (response.valid) {
                        this.showToast('Configuration is valid!', 'success');
                    } else {
                        this.showToast(`Configuration test failed: ${response.error}`, 'error');
                    }
                } catch (error) {
                    this.showToast('Failed to test configuration', 'error');
                }
            }

            nextStep() {
                if (this.currentStep < 3) {
                    // Validate current step
                    if (this.currentStep === 2) {
                        if (!this.validateHost() || !this.validatePort()) {
                            this.showToast('Please fix validation errors before continuing', 'error');
                            return;
                        }
                        this.updateConfig();
                    }

                    this.setStep(this.currentStep + 1);
                }
            }

            prevStep() {
                if (this.currentStep > 1) {
                    this.setStep(this.currentStep - 1);
                }
            }

            setStep(step) {
                // Hide current step content
                document.querySelector('.step-content.active').classList.remove('active');

                // Show new step content
                document.querySelector(`[data-step="${step}"]`).classList.add('active');

                // Update step indicator
                document.querySelectorAll('.step').forEach((stepEl, index) => {
                    stepEl.classList.remove('active', 'completed');
                    if (index + 1 === step) {
                        stepEl.classList.add('active');
                    } else if (index + 1 < step) {
                        stepEl.classList.add('completed');
                    }
                });

                this.currentStep = step;
            }

            startOver() {
                this.currentStep = 1;
                this.selectedProtocol = null;
                this.config = {};

                // Reset form
                document.querySelectorAll('.protocol-card').forEach(card => {
                    card.classList.remove('selected');
                });

                document.querySelectorAll('input, select').forEach(input => {
                    if (input.type !== 'button') {
                        input.value = '';
                    }
                });

                document.querySelectorAll('.validation-message').forEach(msg => {
                    msg.style.display = 'none';
                });

                document.getElementById('next-step-1').disabled = true;

                this.setStep(1);
                this.generateUUID();
            }

            showToast(message, type = 'info') {
                // Simple toast implementation
                const toast = document.createElement('div');
                toast.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
                    type === 'success' ? 'bg-green-500' :
                    type === 'error' ? 'bg-red-500' :
                    type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
                }`;
                toast.textContent = message;

                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new ConfigGenerator();
        });
    </script>
</body>
</html>
