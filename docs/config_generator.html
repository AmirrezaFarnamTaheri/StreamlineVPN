<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamlineVPN Config Generator</title>
    <script src="api-base.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .bg-app { background: radial-gradient(1200px 600px at 20% 10%, rgba(99,102,241,0.15), transparent 60%), radial-gradient(900px 500px at 80% 20%, rgba(236,72,153,0.12), transparent 55%), #0b1020; min-height: 100vh; }
        .glass { background: rgba(255,255,255,0.1); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.2); }
        .config-card { transition: all 0.3s; cursor: pointer; }
        .config-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.15); }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes bounce { 0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); } 40%, 43% { transform: translate3d(0,-8px,0); } 70% { transform: translate3d(0,-4px,0); } 90% { transform: translate3d(0,-2px,0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes fade-out { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
        /* Slow animations */
        .animate-spin { animation: spin 2.5s linear infinite; }
        .animate-bounce { animation: bounce 1.8s infinite; }
        .animate-pulse { animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-app text-white">
    <div class="container mx-auto px-4 py-10 max-w-6xl">
        <!-- Header -->
        <header class="flex items-center justify-between mb-8">
            <div class="flex items-center space-x-4">
                <img src="assets/logo.svg" class="h-12 w-12" alt="Logo">
                <div>
                    <h1 class="text-3xl font-bold">Config Generator</h1>
                    <p class="text-gray-300">Generate and export VPN configurations</p>
                </div>
            </div>
            <a href="index.html" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 transition">
                ‚Üê Back to Home
            </a>
        </header>

        <!-- Controls -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <div class="glass rounded-xl p-6">
                <h2 class="text-xl font-semibold mb-4">Generation Options</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm mb-2">Configuration Source</label>
                        <select id="configSource" class="w-full px-4 py-2 rounded-lg bg-black/30 border border-white/20">
                            <option value="config/sources.yaml">Default (500+ sources)</option>
                            <option value="config/sources.premium.yaml">Premium Only</option>
                            <option value="config/sources.community.yaml">Community Only</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm mb-2">Protocols</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="protocol-filter" value="vless" checked>
                                <span>VLESS</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="protocol-filter" value="vmess" checked>
                                <span>VMess</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="protocol-filter" value="trojan" checked>
                                <span>Trojan</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="protocol-filter" value="ss" checked>
                                <span>Shadowsocks</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm mb-2">Quality Filter</label>
                        <input type="range" id="qualityFilter" min="0" max="100" value="50" 
                               class="w-full" oninput="document.getElementById('qualityValue').textContent = this.value + '%'">
                        <div class="text-right text-sm">
                            Minimum: <span id="qualityValue">50%</span>
                        </div>
                    </div>
                    
                    <button onclick="generateConfigs()" 
                            class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition">
                        Generate Configurations
                    </button>
                </div>
            </div>
            
            <div class="glass rounded-xl p-6">
                <h2 class="text-xl font-semibold mb-4">Export Options</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm mb-2">Export Formats</label>
                        <div class="space-y-2">
                            <label class="flex items-center justify-between p-3 bg-black/20 rounded-lg hover:bg-black/30">
                                <span>JSON</span>
                                <button onclick="exportFormat('json')" class="px-3 py-1 bg-blue-600 rounded text-sm">Export</button>
                            </label>
                            <label class="flex items-center justify-between p-3 bg-black/20 rounded-lg hover:bg-black/30">
                                <span>Clash</span>
                                <button onclick="exportFormat('clash')" class="px-3 py-1 bg-blue-600 rounded text-sm">Export</button>
                            </label>
                            <label class="flex items-center justify-between p-3 bg-black/20 rounded-lg hover:bg-black/30">
                                <span>Sing-Box</span>
                                <button onclick="exportFormat('singbox')" class="px-3 py-1 bg-blue-600 rounded text-sm">Export</button>
                            </label>
                            <label class="flex items-center justify-between p-3 bg-black/20 rounded-lg hover:bg-black/30">
                                <span>Base64</span>
                                <button onclick="exportFormat('base64')" class="px-3 py-1 bg-blue-600 rounded text-sm">Export</button>
                            </label>
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t border-white/20">
                        <div class="text-sm text-gray-300 mb-2">Statistics</div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-2xl font-bold" id="totalConfigs">0</div>
                                <div class="text-xs text-gray-400">Total Configs</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold" id="filteredConfigs">0</div>
                                <div class="text-xs text-gray-400">After Filter</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration List -->
        <div class="glass rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4">Generated Configurations</h2>
            <div id="configList" class="space-y-2 max-h-96 overflow-y-auto">
                <div class="text-center text-gray-400 py-8">
                    <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <p>No configurations generated yet</p>
                    <p class="text-sm mt-2">Click "Generate Configurations" to start</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.__API_BASE__ || 'http://localhost:8080';
        let allConfigs = [];
        let filteredConfigs = [];

        async function generateConfigs() {
            const source = document.getElementById('configSource').value;
            const protocols = Array.from(document.querySelectorAll('.protocol-filter:checked')).map(cb => cb.value);
            const quality = document.getElementById('qualityFilter').value / 100;
            
            showLoading('Starting pipeline...');
            
            try {
                // Start pipeline
                const response = await fetch(`${API_BASE}/api/v1/pipeline/run`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        config_path: source,
                        output_dir: 'output',
                        formats: ['json']
                    })
                });
                
                const ct = response.headers.get('content-type') || '';
                if (!ct.includes('application/json')) {
                    throw new Error('Invalid JSON response from API');
                }
                const result = await response.json();
                
                if (result.job_id) {
                    showLoading('Processing configurations...');
                    // Poll for completion
                    await pollJobStatus(result.job_id);
                }
                
                // Load configurations
                await loadConfigurations(protocols, quality);
                
            } catch (error) {
                console.error('Generation failed:', error);
                showError('Failed to generate configurations. ' + (error && error.message ? error.message : 'Unknown error'));
            }
        }

        async function pollJobStatus(jobId) {
            const maxAttempts = 30;
            for (let i = 0; i < maxAttempts; i++) {
                const url = `${API_BASE}/api/v1/pipeline/status/${jobId}`;
                const response = await fetch(url);
                const ct = response.headers.get('content-type') || '';
                if (!ct.includes('application/json')) {
                    await new Promise(r => setTimeout(r, 1200));
                    continue;
                }
                const status = await response.json();
                
                if (status.status === 'completed') return true;
                if (status.status === 'failed') throw new Error('Pipeline failed');
                
                await new Promise(resolve => setTimeout(resolve, 1200));
            }
            throw new Error('Pipeline timeout. The job did not complete in the expected time window.');
        }

        async function loadConfigurations(protocols, quality) {
            try {
                const API_BASE = window.__API_BASE__ || 'http://localhost:8080';
                const response = await fetch(`${API_BASE}/api/v1/configurations?limit=1000`);
                if (!response.ok) {
                    console.warn(`Config API returned: ${response.status}`);
                    showError('Configuration service temporarily unavailable');
                    return;
                }
                
                const data = await response.json();
                allConfigs = data.configurations || [];
                
                // Apply filters
                filteredConfigs = allConfigs.filter(config => {
                    if (protocols.length && !protocols.includes(config.protocol)) return false;
                    if (config.quality_score && config.quality_score < quality) return false;
                    return true;
                });
                
                // Update stats
                document.getElementById('totalConfigs').textContent = allConfigs.length;
                document.getElementById('filteredConfigs').textContent = filteredConfigs.length;
                
                // Display configs
                displayConfigurations();
            } catch (error) {
                console.warn('Failed to load configurations:', error);
                showError('Unable to load configurations. ' + (error && error.message ? error.message : 'Network error'));
            }
        }

        async function generateConfigs() {
            const API_BASE = window.__API_BASE__ || 'http://localhost:8080';
            try {
                const response = await fetch(`${API_BASE}/api/v1/pipeline/run`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        config_path: 'config/sources.yaml',
                        output_dir: 'output',
                        formats: ['json']
                    })
                });
                
                const result = await response.json();
                if (result.job_id) {
                    alert(`Pipeline started! Job ID: ${result.job_id}`);
                    // Wait a bit then reload configs
                    setTimeout(() => loadConfigurations([], 0), 3000);
                }
            } catch (error) {
                alert('Failed to generate configs: ' + error.message);
            }
        }

        function displayConfigurations() {
            const listEl = document.getElementById('configList');
            
            if (filteredConfigs.length === 0) {
                listEl.innerHTML = '<div class="text-center text-gray-400 py-4">No configurations match filters</div>';
                        return;
                    }
            
            listEl.innerHTML = filteredConfigs.slice(0, 100).map(config => `
                <div class="config-card glass rounded-lg p-4" onclick="showConfigDetails('${config.id || config.server}')">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-sm px-2 py-1 rounded bg-purple-600/30">${config.protocol}</span>
                            <span class="ml-2 font-medium">${config.server}</span>
                            <span class="text-gray-400">:${config.port}</span>
                        </div>
                        <div class="text-right">
                            ${config.quality_score ? `
                                <div class="text-sm">Quality: ${(config.quality_score * 100).toFixed(0)}%</div>
                            ` : ''}
                            ${config.location ? `
                                <div class="text-xs text-gray-400">${config.location.country}</div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function exportFormat(format) {
            if (filteredConfigs.length === 0) {
                showNotification('No configurations to export', 'error');
                return;
            }
            
            // Show loading state
            const exportBtn = event.target;
            const originalText = exportBtn.textContent;
            exportBtn.textContent = 'Exporting...';
            exportBtn.disabled = true;
            
            try {
                let content = '';
                let filename = `vpn_configs.${format}`;
                let mimeType = 'application/json';
                
                switch(format) {
                    case 'json':
                        content = JSON.stringify(filteredConfigs, null, 2);
                        break;
                    case 'base64':
                        const urls = filteredConfigs.map(c => `${c.protocol}://${btoa(JSON.stringify(c))}`).join('\n');
                        content = btoa(urls);
                        mimeType = 'text/plain';
                        filename = 'vpn_configs.txt';
                        break;
                    case 'clash':
                        content = generateClashConfig(filteredConfigs);
                        mimeType = 'text/yaml';
                        filename = 'clash.yaml';
                        break;
                    case 'singbox':
                        content = generateSingBoxConfig(filteredConfigs);
                        filename = 'singbox.json';
                        break;
                }
                
                // Download file
                const blob = new Blob([content], {type: mimeType});
                const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                a.download = filename;
                    a.click();
                URL.revokeObjectURL(url);
                
                showNotification(`Exported ${filteredConfigs.length} configurations as ${format.toUpperCase()}`, 'success');
            } catch (error) {
                showNotification('Export failed: ' + error.message, 'error');
            } finally {
                // Restore button
                exportBtn.textContent = originalText;
                exportBtn.disabled = false;
            }
        }

        function generateClashConfig(configs) {
            // Simplified Clash config generation
            return `mixed-port: 7890
allow-lan: true
mode: rule
proxies:
${configs.map(c => `  - name: "${c.server}"
    type: ${c.protocol}
    server: ${c.server}
    port: ${c.port}
    uuid: ${c.user_id || 'unknown'}
    alterId: 0
    cipher: auto`).join('\n')}`;
        }

        function generateSingBoxConfig(configs) {
            // Simplified Sing-Box config generation
            return JSON.stringify({
                "outbounds": configs.map(c => ({
                    "type": c.protocol,
                    "tag": c.server,
                    "server": c.server,
                    "server_port": c.port,
                    "uuid": c.user_id || "unknown"
                }))
            }, null, 2);
        }

        function showConfigDetails(configId) {
            const config = filteredConfigs.find(c => (c.id || c.server) === configId);
            if (!config) return;
            
            // Show detailed modal (simplified for space)
            alert(JSON.stringify(config, null, 2));
        }

        // Load initial data
        window.addEventListener('load', () => {
            loadConfigurations([], 0);
        });

        // Add loading states and error handling
        function showLoading(message = 'Loading...') {
            const configList = document.getElementById('configList');
            configList.innerHTML = `
                <div class="text-center text-gray-400 py-8">
                    <svg class="w-16 h-16 mx-auto mb-4 opacity-50 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    <p>${message}</p>
                </div>
            `;
        }

        function showError(message) {
            const configList = document.getElementById('configList');
            configList.innerHTML = `
                <div class="text-center text-red-400 py-8">
                    <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p>${message}</p>
                </div>
            `;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 shadow-lg ${
                type === 'success' ? 'bg-green-600' : 'bg-red-600'
            } animate-bounce`;
            
            // Add icon based on type
            const icon = type === 'success' ? 
                '<svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>' :
                '<svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
            
            notification.innerHTML = icon + message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fade-out 0.3s ease-in forwards';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
