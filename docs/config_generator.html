<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamlineVPN Config Generator</title>
    <script src="api-base.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/js/errors.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .bg-app { background: radial-gradient(1100px 520px at 18% 12%, rgba(99,102,241,0.14), transparent 60%), radial-gradient(900px 480px at 82% 18%, rgba(236,72,153,0.10), transparent 55%), #0b1020; min-height: 100vh; }
        .glass { background: rgba(255,255,255,0.1); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.2); }
        .config-card { transition: all 0.3s; cursor: pointer; }
        .config-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.15); }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes bounce { 0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); } 40%, 43% { transform: translate3d(0,-8px,0); } 70% { transform: translate3d(0,-4px,0); } 90% { transform: translate3d(0,-2px,0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes fade-out { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
        /* Slow animations */
        .animate-spin { animation: spin 2.5s linear infinite; }
        .animate-bounce { animation: bounce 1.8s infinite; }
        .animate-pulse { animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-app text-white">
    <div class="container mx-auto px-4 py-10 max-w-6xl">
        <!-- Header -->
        <header class="flex items-center justify-between mb-8">
            <div class="flex items-center space-x-4">
                <img src="assets/logo.svg" class="h-12 w-12" alt="Logo">
                <div>
                    <h1 class="text-3xl font-bold">Config Generator</h1>
                    <p class="text-gray-300">Generate and export VPN configurations</p>
                </div>
            </div>
            <a href="index.html" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 transition">
                ‚Üê Back to Home
            </a>
        </header>

        <!-- Controls -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <div class="glass rounded-xl p-6">
                <h2 class="text-xl font-semibold mb-4">Generation Options</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm mb-2">Configuration Source</label>
                        <select id="configSource" class="w-full px-4 py-2 rounded-lg bg-black/30 border border-white/20">
                            <option value="config/sources.yaml">Default (500+ sources)</option>
                            <option value="config/sources.premium.yaml">Premium Only</option>
                            <option value="config/sources.community.yaml">Community Only</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm mb-2">Protocols</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="protocol-filter" value="vless" checked>
                                <span>VLESS</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="protocol-filter" value="vmess" checked>
                                <span>VMess</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="protocol-filter" value="trojan" checked>
                                <span>Trojan</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="protocol-filter" value="ss" checked>
                                <span>Shadowsocks</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm mb-2">Quality Filter</label>
                        <input type="range" id="qualityFilter" min="0" max="100" value="50" 
                               class="w-full" oninput="document.getElementById('qualityValue').textContent = this.value + '%'">
                        <div class="text-right text-sm">
                            Minimum: <span id="qualityValue">50%</span>
                        </div>
                    </div>
                    
                    <button onclick="generateConfigs()" 
                            class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition">
                        Generate Configurations
                    </button>
                </div>
            </div>
            
            <div class="glass rounded-xl p-6">
                <h2 class="text-xl font-semibold mb-4">Export Options</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm mb-2">Export Formats</label>
                        <div class="space-y-2">
                            <label class="flex items-center justify-between p-3 bg-black/20 rounded-lg hover:bg-black/30">
                                <span>JSON</span>
                                <button onclick="exportFormat('json')" class="px-3 py-1 bg-blue-600 rounded text-sm">Export</button>
                            </label>
                            <label class="flex items-center justify-between p-3 bg-black/20 rounded-lg hover:bg-black/30">
                                <span>Clash</span>
                                <button onclick="exportFormat('clash')" class="px-3 py-1 bg-blue-600 rounded text-sm">Export</button>
                            </label>
                            <label class="flex items-center justify-between p-3 bg-black/20 rounded-lg hover:bg-black/30">
                                <span>Sing-Box</span>
                                <button onclick="exportFormat('singbox')" class="px-3 py-1 bg-blue-600 rounded text-sm">Export</button>
                            </label>
                            <label class="flex items-center justify-between p-3 bg-black/20 rounded-lg hover:bg-black/30">
                                <span>Base64</span>
                                <button onclick="exportFormat('base64')" class="px-3 py-1 bg-blue-600 rounded text-sm">Export</button>
                            </label>
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t border-white/20">
                        <div class="text-sm text-gray-300 mb-2">Statistics</div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-2xl font-bold" id="totalConfigs">0</div>
                                <div class="text-xs text-gray-400">Total Configs</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold" id="filteredConfigs">0</div>
                                <div class="text-xs text-gray-400">After Filter</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration List -->
        <div class="glass rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4">Generated Configurations</h2>
            <div id="configList" class="space-y-2 max-h-96 overflow-y-auto">
                <div class="text-center text-gray-400 py-8">
                    <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <p>No configurations generated yet</p>
                    <p class="text-sm mt-2">Click "Generate Configurations" to start</p>
                </div>
            </div>
        </div>
    </div>

<script>
    // Ensure API base is set correctly
    const API_BASE = (() => {
        if (window.__API_BASE__ && window.__API_BASE__.startsWith('http')) {
            return window.__API_BASE__;
        }
        const host = window.location.hostname;
        if (host === 'localhost' || host === '127.0.0.1') {
            return `http://${host}:8080`;
        } else if (host.includes('github.io')) {
            // Force localhost for GitHub pages
            return 'http://localhost:8080';
        }
        return `${window.location.protocol}//${host}`;
    })();

    let allConfigs = [];
    let filteredConfigs = [];

    const el = (id) => document.getElementById(id);
    const qsa = (sel) => Array.from(document.querySelectorAll(sel));

    // --- Data Fetching and Processing ---

    async function generateConfigs() {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<span class="flex items-center justify-center"><svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Generating...</span>`;

        try {
            const configPath = el('configSource').value;
            const response = await fetch(`${API_BASE}/api/v1/pipeline/run`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    config_path: configPath,
                    output_dir: 'output',
                    formats: ['json', 'clash', 'singbox', 'base64'] // Generate all formats
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ detail: 'An unknown error occurred.' }));
                throw new Error(errorData.detail || `HTTP Error ${response.status}`);
            }
            
            const result = await response.json();
            showNotification(`Processing started! Job ID: ${result.job_id}. Configs will refresh shortly.`, 'success');
            
            // Poll for completion and then reload
            pollJobStatus(result.job_id);

        } catch (error) {
            console.error('Generate error:', error);
            showNotification(`Failed to start generation: ${error.message}`, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText.replace('Generating...', 'Generate Configurations');
        }
    }

    async function pollJobStatus(jobId) {
        const interval = setInterval(async () => {
            try {
                const response = await fetch(`${API_BASE}/api/v1/pipeline/status/${jobId}`);
                if (!response.ok) return; // Silently fail
                const status = await response.json();
                if (status.status === 'completed') {
                    clearInterval(interval);
                    showNotification('Generation complete! Reloading configurations...', 'success');
                    await loadConfigs();
                } else if (status.status === 'failed') {
                    clearInterval(interval);
                    showNotification('Generation job failed.', 'error');
                }
            } catch (e) {
                // Ignore polling errors
            }
        }, 3000);
    }

    async function loadConfigs() {
        const configList = el('configList');
        configList.innerHTML = '<div class="text-center text-gray-400 py-8">Loading...</div>';

        try {
            const response = await fetch(`${API_BASE}/api/v1/configurations?limit=2000`); // Fetch a large number
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            allConfigs = data.configurations || [];
            applyFilters();

        } catch (error) {
            console.error('Load configs error:', error);
            configList.innerHTML = `<div class="text-center text-red-500 py-8">Error loading configurations: ${error.message}</div>`;
        }
    }

    // --- Filtering and Rendering ---

    function applyFilters() {
        const qualityThreshold = parseInt(el('qualityFilter').value, 10) / 100;
        const allowedProtocols = qsa('.protocol-filter:checked').map(cb => cb.value);

        filteredConfigs = allConfigs.filter(config => {
            const qualityMatch = (config.quality_score || 0) >= qualityThreshold;
            const protocolMatch = allowedProtocols.includes(config.protocol);
            return qualityMatch && protocolMatch;
        });

        renderConfigs();
    }

    function renderConfigs() {
        el('totalConfigs').textContent = allConfigs.length;
        el('filteredConfigs').textContent = filteredConfigs.length;

        const configList = el('configList');
        if (filteredConfigs.length === 0) {
            configList.innerHTML = `
                <div class="text-center text-gray-400 py-8">
                    <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <p>No configurations match your filters.</p>
                    <p class="text-sm mt-2">Try adjusting the quality slider or selecting more protocols.</p>
                </div>`;
            return;
        }

        configList.innerHTML = filteredConfigs.map(config => `
            <div class="config-card glass p-3 rounded-lg flex justify-between items-center">
                <div>
                    <span class="text-xs px-2 py-1 rounded-full bg-purple-600/50">${config.protocol || 'N/A'}</span>
                    <span class="ml-3 font-mono text-sm">${config.server || 'Unknown'}:${config.port || 0}</span>
                </div>
                <div class="text-sm text-gray-300">
                    Quality: <span class="font-semibold text-green-400">${(config.quality_score * 100).toFixed(0)}%</span>
                </div>
            </div>
        `).join('');
    }

    // --- Exporting ---

    function exportFormat(format) {
        if (filteredConfigs.length === 0) {
            showNotification('No configurations to export. Adjust filters first.', 'error');
            return;
        }

        let content = '';
        let filename = `streamline-configs-${new Date().toISOString().split('T')[0]}`;
        let mimeType = 'text/plain';

        try {
            switch(format) {
                case 'json':
                    content = JSON.stringify(filteredConfigs, null, 2);
                    filename += '.json';
                    mimeType = 'application/json';
                    break;
                case 'clash':
                    const clashData = {
                        proxies: filteredConfigs.map(c => {
                            let proxy = {
                                name: `${c.protocol}-${c.server}:${c.port}`,
                                type: c.protocol,
                                server: c.server,
                                port: c.port,
                            };
                            if (c.password) proxy.password = c.password;
                            if (c.ws_path) proxy['ws-opts'] = { path: c.ws_path };
                            if (c.tls) proxy.tls = c.tls;
                            return proxy;
                        })
                    };
                    // A proper YAML serializer would be better, but this is a simple approximation
                    content = `proxies:\n${clashData.proxies.map(p => `  - ${JSON.stringify(p)}`).join('\n')}`;
                    filename += '.yaml';
                    mimeType = 'application/x-yaml';
                    break;
                case 'singbox':
                     content = JSON.stringify({
                        outbounds: filteredConfigs.map(c => ({
                            type: c.protocol,
                            tag: `${c.protocol}-${c.server}`,
                            server: c.server,
                            server_port: c.port
                        }))
                    }, null, 2);
                    filename += '.json';
                    mimeType = 'application/json';
                    break;
                case 'base64':
                    const subLinks = filteredConfigs.map(c => `${c.protocol}://${c.server}:${c.port}`); // Simplified
                    content = btoa(subLinks.join('\n'));
                    filename += '.txt';
                    mimeType = 'text/plain';
                    break;
            }
            downloadFile(content, filename, mimeType);
            showNotification(`Exported ${filteredConfigs.length} configs as ${format}.`, 'success');
        } catch (e) {
            console.error(`Export failed for format ${format}:`, e);
            showNotification(`Export failed: ${e.message}`, 'error');
        }
    }

    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // --- UI Utilities ---

    function showNotification(message, type = 'info') {
        const container = el('notification-container') || createNotificationContainer();
        const color = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';

        const notification = document.createElement('div');
        notification.className = `p-4 rounded-lg text-white shadow-lg mb-2 ${color} transition-all duration-300 transform translate-x-full`;
        notification.textContent = message;

        container.prepend(notification);

        // Animate in
        setTimeout(() => notification.classList.remove('translate-x-full'), 10);

        // Animate out and remove
        setTimeout(() => {
            notification.classList.add('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => notification.remove(), 500);
        }, 4000);
    }

    function createNotificationContainer() {
        let container = el('notification-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notification-container';
            container.className = 'fixed top-4 right-4 w-80 z-50';
            document.body.appendChild(container);
        }
        return container;
    }


    // --- Initialization ---

    window.addEventListener('DOMContentLoaded', () => {
        loadConfigs();

        // Add event listeners to filter controls
        qsa('.protocol-filter').forEach(cb => cb.addEventListener('change', applyFilters));

        const qualitySlider = el('qualityFilter');
        qualitySlider.addEventListener('input', () => {
            el('qualityValue').textContent = qualitySlider.value + '%';
            applyFilters();
        });
    });
</script>
</body>
</html>
