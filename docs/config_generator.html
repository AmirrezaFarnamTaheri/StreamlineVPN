<!DOCTYPE html>
<html>
<head>
    <title>StreamlineVPN Config Generator</title>
    <link rel="stylesheet" href="assets/site.css" />
    <script src="/api-base.js"></script>
</head>
<body class="config-generator">
    <div class="container">
        <h1>ðŸš€ StreamlineVPN Config Generator</h1>
        <p>Generate and download VPN configurations in multiple formats.</p>

        <div>
            <button class="button" onclick="loadConfigs()">Load Configurations</button>
            <button class="button" onclick="generateConfigs()">Generate New</button>
        </div>

        <div class="config-list" id="configList">
            <p>Click "Load Configurations" to see available configurations.</p>
        </div>

        <div>
            <h3>Download Formats:</h3>
            <button class="button" onclick="downloadConfigs('json')">JSON</button>
            <button class="button" onclick="downloadConfigs('text')">Text</button>
            <button class="button" onclick="downloadConfigs('download')">Download JSON</button>
        </div>
    </div>

    <script>
        const API_BASE = (() => {
            const injected = window.__API_BASE__;
            if (typeof injected === 'string' && injected.startsWith('http')) return injected;
            const hostname = window.location.hostname;
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return `http://${hostname}:8080`;
            }
            return `${window.location.protocol}//${window.location.host}`;
        })();

        async function loadConfigs() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/configurations?limit=50`);
                const data = await response.json();
                const configs = data.configurations || [];
                const configList = document.getElementById('configList');
                const configsHTML = configs.map(
                    config => `
                    <div class="config-item">
                        <strong>${config.protocol}</strong>
                        - ${config.server}:${config.port}
                        <br><small>Quality: ${
                            (config.quality_score != null && !isNaN(config.quality_score))
                                ? Number(config.quality_score).toFixed(2)
                                : 'N/A'
                        }</small>
                    </div>`
                ).join('');
                configList.innerHTML = `
                    <h3>Available Configurations (${configs.length})</h3>
                    ${configsHTML}
                `;
            } catch (error) {
                alert('Error loading configurations: ' + error.message);
            }
        }

        async function generateConfigs() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/pipeline/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        config_path: 'config/sources.unified.yaml',
                        output_dir: 'output',
                        formats: ['json','clash','singbox','raw']
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    alert(data.message || 'Pipeline started');
                } else {
                    throw new Error(data.detail || 'Failed to start pipeline');
                }
                loadConfigs();
            } catch (error) {
                alert("Error generating configurations: " + error.message);
            }
        }

        function downloadConfigs(format) {
            // Export is served by the static server on the current origin
            window.open(`/api/export/${format}`, '_blank');
        }
    </script>
</body>
</html>


